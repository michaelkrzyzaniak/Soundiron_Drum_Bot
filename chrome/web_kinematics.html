<!doctype HTML>
<html>
  <head>
    <style>
       body
         {
           margin:0px; 
           padding:0px; 
           background-color:#66d;
         }
      .page_div
        {
           width:650px;
           background-color:#CCC;
           padding:10px;
           margin:40px auto 40px auto;
           font-family:'Verdana';
           font-size:9pt;
           border-radius:6px;
           box-shadow:5px 5px 30px #222;
        }
      .top_buttons_div
        {
          margin:auto;
        }
      .top_buttons_div .dropdown_div
        {
          display:inline-block;
        }
      .top_buttons_div .button_div
        {
          margin: 10px auto auto auto;
          font-size:0pt;
        }
      .top_buttons_div .button_div .button_container
        {
          display:inline-block;
          width:20%;
          text-align:center;
          font-size:9pt;
        }
      .top_buttons_div .button_div .button_container button
        {
          font:inherit;
          width:90%;
        }
      .log_container_div
        {
          margin:auto;
          padding:10px;
          font-size:0pt;
        }
      .log_container_div .button_div
        {
          display:inline-block;
          width:15%;
          height:12em;
          font-size:9pt;
          vertical-align:top;
          text-align:right;
        }
      .log_container_div .button_div button
        {
          width:85%;
          font-size:9pt;
        }
      .log_container_div .log_outer_div
        {
          background-color:white;
          font-size:9pt;
          color:#888;
          display:inline-block;
          width:85%;
          vertical-align:top;
        }
      .log_container_div .log_div
        {
          margin:auto;
          padding:10px;
          overflow:auto;
          height:12em;
        }
      #log .send_message
        {
          color:#888;
        }
      #log .receive_message
        {
          color:blue;
        }
      #log .error_message
        {
          color:#800;
        }
      .params_div
        {
           width:100%;
           columns: 3 auto;
           font-size:0px;
        }
      .param_container
        {
           width:90%;
           padding:1px 5px 1px 5px;
        }
      .param_container div
        {
           display:inline-block;
           vertical-align: middle;
           margin:0px;
           padding:0px;
           font-size:9pt;
        }
      .param_container .label_div
        {
           width:5%;
        }
      .param_container .get_div
        {
           width:10%;
           text-align:center;
        }
      .param_container .get_div button
        {

        }
      .param_container .value_div
        {
          width:33%;
        }
      .param_container .value_div input, .param_container .value_div select
        {
           font:inherit;
           width:200%;
           margin:0px;
        }
    </style>
    <script>
      var should_log  = false;
      var finger_id   = 0;
      var string_id   = 1;
      var strum_end   = 1;
      var double_damp = 0
      var finger_widget;
      var x = 90;
      var y = 30;
      var a = 0.9*Math.PI/2;
      var midi_outputs  = [];
      
      function init_page()
      {
        populate_midi_device_list();
        finger = new Finger("finger_widget");
        finger.draw(x, y, a);
        display_number('x', x);
        display_number('y', y);
        display_number('a', a);
        //get_endpoint_positions();
      }
      
      function populate_midi_device_list()
      {
        if(!navigator.requestMIDIAccess) return;
        navigator.requestMIDIAccess({sysex: true}).then(function(midiAccess)
        {
          var i;
          var list = document.getElementById("midi_device_list");
          list.innerHTML = "";
          midi_outputs = Array.from(midiAccess.outputs.values());
          for(i=0; i<midi_outputs.length; i++)
            list.innerHTML += "<option value='"+i+"'>"+midi_outputs[i].name+"</option>";
          if(midi_outputs.length == 0)
            list.innerHTML += "<option value='-1'>None Connected</option>";
            
          //listen to everything
          var midi_inputs = Array.from(midiAccess.inputs.values());
          for(i=0; i<midi_inputs.length; i++)
            midi_inputs[i].addEventListener('midimessage', midi_message_receive_callback);
        });
      }
      
      function midi_message_receive_callback(event)
      {
        var message = event.data;
        var args = [];
        var type = "";
        var i;
  
        //this assumes event contains a complete sysex message.
        //todo: properly parse the MIDI it incase it comes in a stream
        if(message.length < 3) return;
        if(message[0] != 0xF0) return;
        if(message[1] != 0x00) return;
        if(message[message.length-1] != 0xF7) return;
        
        var str_message = "";
        
        for(i=2; i<message.length-1; i++)
          str_message += String.fromCharCode(message[i]);
        
        log(str_message, "receive_message")
        var args = str_message.split(" ");
        var message = args.shift();
  
        message_dispatch(message, args)
      }

      function message_dispatch(message, args)
      {
        if((message == "/rh_target_endpoint") || (message == "/rh_calculated_endpoint"))
          if(args.length == 4)
            {
              finger.draw(parseFloat(args[1]), parseFloat(args[2]), parseFloat(args[3]));
              display_number('x', args[1]);
              display_number('y', args[2]);
              display_number('a', args[3]);
              x = args[1];
              y = args[2];
              a = args[3];
            }
      }
      
      function robot_send_message(message, type_tag)
      {
        var i;
        for(i=0; i<type_tag.length; i++)
          message += " " + arguments[i+2];
        
        var hex_message = [0xF0, 0x00];
        for(i=0; i<message.length; i++)
          hex_message.push(message.charCodeAt(i));
        hex_message.push(0xF7);
          
        if(midi_outputs.length > 0)
          {
            var device_index = document.getElementById("midi_device_list").value;
            var device = null;
            if(device_index >= 0)
              device = midi_outputs[device_index];
            
            if(device)
              device.send(hex_message);
           }
        log(message, "send_message");
      }
      
      function get_parameter_data_register(caller)
      {
        return parseInt(caller.parentNode.parentNode.getAttribute("data-parameter"));
      }

      function get_target_endpoint_position()
      {
        //gets the last valid endpoint parameters that were set
        //the arm could have moved while the motors were powered off
        //and this will not reflect that
        robot_send_message("/rh_get_target_endpoint", "i", finger_id);
        
        if(midi_outputs.length == 0)
          message_dispatch("/rh_target_endpoint", [finger_id, x, y, a]);
      }

      function get_calculated_endpoint_position()
      {
        //gets servo locations and calculates forward kinematics
        //note that the arm might be moving, this reports the current position, not the target
        robot_send_message("/rh_get_calculated_endpoint", "i", finger_id);
        
        if(midi_outputs.length == 0)
          message_dispatch("/rh_calculated_endpoint", [finger_id, x, y, a]);
      }

      function set_endpoint_positions(_x, _y, _a)
      {
        //send some message
        robot_send_message("/rh_set_endpoint", "iffff", finger_id, 1.0 /*speed coefficient*/, parseFloat(_x).toFixed(1), parseFloat(_y).toFixed(1), parseFloat(_a).toFixed(3));
        get_target_endpoint_position()
      }

      function set_xy(_x, _y)
      {
        x = parseFloat(_x);
        y = parseFloat(_y);
        set_endpoint_positions(x, y, a);
      }
      
      function set_x(_x)
      {
        x = parseFloat(_x);
        set_endpoint_positions(x, y, a);
      }

      function set_y(_y)
      {
        y = parseFloat(_y);
        set_endpoint_positions(x, y, a);
      }
      
      function set_a(_a)
      {
        a = parseFloat(_a);
        set_endpoint_positions(x, y, a);
      }
      
      function set_finger_id(val)
      {
        finger_id = val;
        get_calculated_endpoint_position();
      }
      
      function set_string_id(val)
      {
        string_id = val;
      }

      function set_strum_end(val)
      {
        strum_end = val;
      }
      
      function set_double_damp(val)
      {
        log("double damp", val)
        double_damp = val ? 1 : 0;
      }
      
      function rh_move_to_string()
      {
        robot_send_message("/rh_move_to_string", "ii", finger_id, string_id);
      }
      
      function rh_capture_string()
      {
        robot_send_message("/rh_capture_string", "ii", finger_id, string_id);
      }
      
      function pluck_string()
      {
        robot_send_message("/rh_strum", "iiif", finger_id, string_id, string_id, 1);
      }

      function damp_string()
      {
        robot_send_message("/rh_damp", "iii", finger_id, string_id, double_damp);
      }
      
      function strum()
      {
        robot_send_message("/rh_strum", "iiif", finger_id, string_id, strum_end, 1);
      }
      
      function rh_enable_torque(val)
      {
        var enable = (val == true) ? 1 : 0;
        robot_send_message("/rh_set_torque", "ii", finger_id, enable);
      }

      function display_number(parameter, val)
      {
        //parameter = parseInt(parameter).toString(16).toUpperCase();
        var param = document.querySelector("div[data-parameter='"+parameter+"']");
        if(param)
          {
            var value_div = param.querySelector(".value_div");
            var input     = value_div.querySelector("input");
            if(input)
              {
                if(input.type == "checkbox")
                  input.checked = (parseInt(val) != 0);
                else
                  input.value = val;
              }
            else
             {
               input = value_div.querySelector("select");
               if(input)
                 {
                   input.value = parseInt(val);
                 }
             }
          }
      }
      
      function log(message, class_name)
      {
        if(should_log)
          {
            message = "<span class='"+class_name+"'>" + message + "</span><br>";
            var log = document.getElementById("log");
            log.innerHTML += message;
            log.scrollTop = log.scrollHeight;
          }
      }
      
      function clear_log()
      {
        document.getElementById("log").innerHTML = "";
      }
    </script>
    
    
    <script>
      /*--------------------------------------------------------------------*/
      //millimeter units
      /*
      Finger.L0                       = 24+97;
      Finger.L1                       = 20+87;
      Finger.L2                       = 20+25+11;
      Finger.A1_RANGE_OF_MOTION       = Math.PI/2.0;
      Finger.A2_RANGE_OF_MOTION       = Math.PI/2.0;
      Finger.ZAP_HOUSING_LENGTH_1     = 75.8;
      Finger.ZAP_HOUSING_LENGTH_2     = 75.8;
      Finger.ZAP_MAX_EXTENSION_1      = 27;
      Finger.ZAP_MAX_EXTENSION_2      = 27;
      //distance from zap lower mount point to top of segment (joint)
      Finger.LEVER_LENGTH_1           = Math.sqrt(Math.pow(Finger.ZAP_MAX_EXTENSION_1, 2) / (2*(1-Math.cos(Finger.A1_RANGE_OF_MOTION))));
      Finger.LEVER_LENGTH_2           = Math.sqrt(Math.pow(Finger.ZAP_MAX_EXTENSION_2, 2) / (2*(1-Math.cos(Finger.A2_RANGE_OF_MOTION))));
      Finger.LEVER_ANGLE_1            = 0;//Math.PI / 8.0;
      Finger.LEVER_ANGLE_2            = 0;//Math.PI / 8.0;
      //nub for the servo lower mountpoint
      Finger.MOUNTING_OUTSTICK_LENGTH_1 = 0;
      Finger.MOUNTING_OUTSTICK_LENGTH_2 = 0;
      //length of the segment from from mount point nub to top of segment (joint)
      Finger.ZAP_PROJECTION_LENGTH_1  = Math.sqrt(Math.pow(Finger.ZAP_HOUSING_LENGTH_1+(Finger.ZAP_MAX_EXTENSION_1/2.0), 2) - Math.pow((Finger.LEVER_LENGTH_1-Finger.MOUNTING_OUTSTICK_LENGTH_1), 2));
      Finger.ZAP_PROJECTION_LENGTH_2  = Math.sqrt(Math.pow(Finger.ZAP_HOUSING_LENGTH_2+(Finger.ZAP_MAX_EXTENSION_2/2.0), 2) - Math.pow((Finger.LEVER_LENGTH_2-Finger.MOUNTING_OUTSTICK_LENGTH_2), 2));
      */
      
      /*
      Finger.L0                       = 24+97;
      Finger.L1                       = 20+87;
      Finger.L2                       = 16+30.8;//25+11;
      Finger.A1_RANGE_OF_MOTION       = 120 * Math.PI/180.0;
      Finger.A2_RANGE_OF_MOTION       = 125 * Math.PI/180.0;
      Finger.ZAP_HOUSING_LENGTH_1     = 75.8;
      Finger.ZAP_HOUSING_LENGTH_2     = 75.8;
      Finger.ZAP_MAX_EXTENSION_1      = 27;
      Finger.ZAP_MAX_EXTENSION_2      = 27;
      //distance from zap lower mount point to top of segment (joint)
      Finger.LEVER_LENGTH_1           = 15.6;//Math.sqrt(Math.pow(Finger.ZAP_MAX_EXTENSION_1, 2) / (2*(1-Math.cos(Finger.A1_RANGE_OF_MOTION))));
      Finger.LEVER_LENGTH_2           = 15.2;//Math.sqrt(Math.pow(Finger.ZAP_MAX_EXTENSION_2, 2) / (2*(1-Math.cos(Finger.A2_RANGE_OF_MOTION))));
      Finger.LEVER_ANGLE_1            = Math.PI / 8.0;
      Finger.LEVER_ANGLE_2            = -55 * Math.PI/180.0;
      //nub for the servo lower mountpoint
      Finger.MOUNTING_OUTSTICK_LENGTH_1 = Finger.LEVER_LENGTH_1;//20;
      Finger.MOUNTING_OUTSTICK_LENGTH_2 = Finger.LEVER_LENGTH_2;//20;
      //length of the segment from from mount point nub to top of segment (joint)
      Finger.ZAP_PROJECTION_LENGTH_1  = 89.3;//Math.sqrt(Math.pow(Finger.ZAP_HOUSING_LENGTH_1+(Finger.ZAP_MAX_EXTENSION_1/2.0), 2) - Math.pow((Finger.LEVER_LENGTH_1-Finger.MOUNTING_OUTSTICK_LENGTH_1), 2));
      Finger.ZAP_PROJECTION_LENGTH_2  = 89.3;//Math.sqrt(Math.pow(Finger.ZAP_HOUSING_LENGTH_2+(Finger.ZAP_MAX_EXTENSION_2/2.0), 2) - Math.pow((Finger.LEVER_LENGTH_2-Finger.MOUNTING_OUTSTICK_LENGTH_2), 2));
      */
      
      Finger.L0                       = 24+97;
      Finger.L1                       = 20+87;
      Finger.L2                       = 10+30.8//16+30.8;//25+11;
      Finger.A1_RANGE_OF_MOTION       = 120 * Math.PI/180.0;
      Finger.A2_RANGE_OF_MOTION       = 125 * Math.PI/180.0;
      Finger.ZAP_HOUSING_LENGTH_1     = 75.8;
      Finger.ZAP_HOUSING_LENGTH_2     = 75.8;
      Finger.ZAP_MAX_EXTENSION_1      = 27;
      Finger.ZAP_MAX_EXTENSION_2      = 27;
      //distance from zap lower mount point to top of segment (joint)
      Finger.LEVER_LENGTH_1           = 15.6;//Math.sqrt(Math.pow(Finger.ZAP_MAX_EXTENSION_1, 2) / (2*(1-Math.cos(Finger.A1_RANGE_OF_MOTION))));
      Finger.LEVER_LENGTH_2           = 15.2;//Math.sqrt(Math.pow(Finger.ZAP_MAX_EXTENSION_2, 2) / (2*(1-Math.cos(Finger.A2_RANGE_OF_MOTION))));
      Finger.LEVER_ANGLE_1            = Math.PI / 8.0 - 0.35;
      Finger.LEVER_ANGLE_2            = -55 * Math.PI/180.0;
      //nub for the servo lower mountpoint
      Finger.MOUNTING_OUTSTICK_LENGTH_1 = Finger.LEVER_LENGTH_1;//20;
      Finger.MOUNTING_OUTSTICK_LENGTH_2 = Finger.LEVER_LENGTH_2;//20;
      //length of the segment from from mount point nub to top of segment (joint)
      Finger.ZAP_PROJECTION_LENGTH_1  = 89.3;//Math.sqrt(Math.pow(Finger.ZAP_HOUSING_LENGTH_1+(Finger.ZAP_MAX_EXTENSION_1/2.0), 2) - Math.pow((Finger.LEVER_LENGTH_1-Finger.MOUNTING_OUTSTICK_LENGTH_1), 2));
      Finger.ZAP_PROJECTION_LENGTH_2  = 89.3;//Math.sqrt(Math.pow(Finger.ZAP_HOUSING_LENGTH_2+(Finger.ZAP_MAX_EXTENSION_2/2.0), 2) - Math.pow((Finger.LEVER_LENGTH_2-Finger.MOUNTING_OUTSTICK_LENGTH_2), 2));
      
      //console.log("lever 1", Finger.LEVER_LENGTH_1);
      //console.log("lever 2", Finger.LEVER_LENGTH_2);
      //console.log("Proj 1", Finger.ZAP_PROJECTION_LENGTH_1);
      //console.log("Proj 2", Finger.ZAP_PROJECTION_LENGTH_2);


      //mm coordinates of first joint
      Finger.START_X                 = 200;
      Finger.START_Y                 = 50;
      
      Finger.MM_TO_PIXELS_SCALE      = 2.0;

      /*--------------------------------------------------------------------*/
      function Finger(canvas_id)
      {
        this.canvas             = document.getElementById(canvas_id);
        this.context            = this.canvas.getContext('2d');
  
        this.context.lineCap      = "round";
        //this.context.lineWidth    = 0.01 * this.radius;
        this.context.textAlign    = "center";
        this.context.textBaseline = "bottom";
  

        this.canvas.addEventListener("touchstart", this.touchstart.bind(this), false);
        this.canvas.addEventListener("touchend"  , this.touchend.bind(this)  , false);
        this.canvas.addEventListener("touchmove" , this.touchmove.bind(this)  , false);
        document.body.addEventListener("touchmove", this.prevent_touch_scroll.bind(this), {passive:false, capture:false});
        this.canvas.onmousedown = this.onmousedown.bind(this);
        //this.canvas.onmouseenter= this.onmousedown.bind(this);
        this.canvas.onmouseup   = this.onmouseup.bind  (this);
        this.canvas.onmouseout  = this.onmouseup.bind  (this);
        this.canvas.onmousemove = this.onmousemove.bind(this);
  
        this.is_updating   = false;
        this.update_thread = null;
        
        this.mouse_is_down = false;
        this.mouse_is_down_in_p3 = false;
        this.mouse_is_down_in_p2 = false;
        this.p2x = -1000;
        this.p2y = -1000;
        this.p3x = -1000;
        this.p3y = -1000;
        this.a   = Math.PI / 2;
        //this.resume_updating();
      }

      /*--------------------------------------------------------------------*/
      Finger.prototype.stop_updating = function()
      {
        clearTimeout(this.update_thread);
        this.is_updating = false;
      };

      /*--------------------------------------------------------------------*/
      Finger.prototype.resume_updating = function()
      {
        if(this.is_updating === false)
          this.update_thread_run_loop_run();
        this.is_updating = true;
      };

      /*--------------------------------------------------------------------*/
      Finger.prototype.arm_endpoint_location_to_servo_angles = function(x, y, a)
      {
        var p1x , p2x , p3x ;             //servo positions
        var p1y , p2y , p3y , p4y;        //servo positions
        var a0  , a1  , a2  , a3  , a4  ; //angles (theta)
        var l0  , l1  , l2  , l3  , l4  ; //segment lengths
        var l0_2, l1_2, l2_2, l3_2, l4_2; //lengths squared
        var H;
        var lambda1 = 1, lambda2 = 1;
        var _x, _y;
  
        //a = (endpoint->a  + offset->a) / 1000.0;
  
        //if(x < ARM_MIN_X) return SERVO_ERROR_RANGE;
  
        l0     = Finger.L0;
        l1     = Finger.L1;
        l2     = Finger.L2;
        l0_2   = l0 * l0;
        l1_2   = l1 * l1;
        l2_2   = l2 * l2;
        p2x    = x - l2 * Math.cos(a);
        p2y    = y + l2 * Math.sin(a);
        l3_2   = (p2x*p2x) + (p2y*p2y);
        l3     = Math.sqrt(l3_2);
        if     (l3 > l0 + l1) return null;
        //l3_2   = l3 * l3;
        if(l3 != 0) lambda1 = 0.5 + (l0_2 - l1_2) / (2 * l3_2);
        p3x    = p2x * lambda1;
        p3y    = p2y * lambda1;
        //a3     = acos( ((l1_2) + (l3_2) - (l0_2)) / (2 * l1 * l3) );
        //H      = l1 * sin(a3);
        a3     = ((l1_2) + (l3_2) - (l0_2)) / (2 * l1 * l3);
        H      = l1 * Math.sqrt(1 - (a3*a3));
        //a4     = acos(p2x / l3);
        //p1y    = p3y + H * cos(a4);
        a4     = p2x / l3;
        p1y    = p3y + H * a4;
  
        if(p2y >= 0) H = -H;
        //p1x    = p3x + H * sin(a4);
        p1x    = p3x + H * Math.sqrt(1-(a4*a4));
        _x     = x - p1x;
        _y     = y - p1y;
        l4     = Math.sqrt(_x*_x + _y*_y);
        l4_2   = l4 * l4;
        a0     = Math.asin(p1y / l0) + Math.PI;
        a1     = Math.acos( ((l0_2) + (l1_2) - (l3_2)) / (2 * l0 * l1) );
        a2     = (2 * Math.PI) - Math.acos( ((l1_2) + (l2_2) - (l4_2)) / (2 * l1 * l2) );
        if     (Number.isNaN(a0) || Number.isNaN(a1) || Number.isNaN(a2)) return null;
        if(l4 != 0) lambda2 = 0.5 + (l1_2 - l2_2) / (2 * l4_2);
        p4y    = p1y + _y * lambda2;
  
        if(x > p1x)
          if(p2y > p4y)
            a2 = (Math.PI * 2) - a2;
  
        if(x < p1x)
          if(p2y < p4y)
            a2 = (Math.PI * 2) - a2;
  
        if(p1x < 0)
          a0 = 3*Math.PI-a0;
  
        //for touch detection
        return [a0, a1, a2, p2x, p2y];
      }

      /*--------------------------------------------------------------------*/
      Finger.prototype.angles_to_actuators = function(a0, a1, a2)
      {
        console.log(a1 * 180 / Math.PI);
        var a0_offset = 0;//Math.PI/2;
        
        var A0, A1, A2;
        var term_1, term_2, lever_leftover, corrected_projection;
        
        A0 = a0 - a0_offset;
        while(A0 < 0)
          A0 += 2*Math.PI;
        while(A0 > 2*Math.PI)
          A0 -= 2*Math.PI;
          
        a1 += Finger.LEVER_ANGLE_1;
        a2 += Finger.LEVER_ANGLE_2;
        
        lever_leftover = Finger.LEVER_LENGTH_1 - Finger.MOUNTING_OUTSTICK_LENGTH_1 / Math.sin(a1);
        corrected_projection = Finger.ZAP_PROJECTION_LENGTH_1 + Finger.MOUNTING_OUTSTICK_LENGTH_1 / Math.tan(a1);
        term_1  = (corrected_projection * corrected_projection);
        term_1 += (lever_leftover * lever_leftover);
        term_2  = 2 * corrected_projection * lever_leftover;
        term_2 *= Math.cos(Math.PI - a1);
        A1     = Math.sqrt(term_1 - term_2) - Finger.ZAP_HOUSING_LENGTH_1;

        lever_leftover = Finger.LEVER_LENGTH_2 - Finger.MOUNTING_OUTSTICK_LENGTH_2 / Math.sin(a2);
        corrected_projection = Finger.ZAP_PROJECTION_LENGTH_2 + Finger.MOUNTING_OUTSTICK_LENGTH_2 / Math.tan(a2);
        term_1  = (lever_leftover * lever_leftover);
        term_1 += (corrected_projection * corrected_projection)
        term_2  = 2 * corrected_projection * lever_leftover;
        term_2 *= Math.cos(Math.PI - a2);
        A2      = Math.sqrt(term_1 - term_2) - Finger.ZAP_HOUSING_LENGTH_2;
        
        return [A0, A1, A2];
      };
      
      //PRIVATE
      /*--------------------------------------------------------------------*/
      Finger.prototype.draw = function(x, y, alpha)
      {
        angles = this.arm_endpoint_location_to_servo_angles(x, y, alpha);
        if(angles == null) return;
        
        var a0 = angles[0];
        var a1 = angles[1];
        var a2 = angles[2];
        
        var A = this.angles_to_actuators(a0, a1, a2);
        var A0 = A[0];
        var A1 = A[1];
        var A2 = A[2];
        
        if((A1 < 0) || (A1 > Finger.ZAP_MAX_EXTENSION_1)) return;
        if((A2 < 0) || (A2 > Finger.ZAP_MAX_EXTENSION_2)) return;
        
        if(angles[4] <= y) return;
        
        this.p3x = x;
        this.p3y = y;
        this.a = alpha;
        this.p2x = angles[3];
        this.p2y = angles[4];
        
        var h = this.canvas.height;
        var w = this.canvas.width;
        var scale = Finger.MM_TO_PIXELS_SCALE;
        var start_x = Finger.START_X * scale;
        var start_y = Finger.START_Y * scale;
        var joint_radius = 5 * scale;
        var attachment_radius = 2.5 * scale;
        var temp;
        
        this.context.font = "bold " + 12 + "px Verdana";
        this.context.fillStyle = "white";
        this.context.fillRect(0, 0, w, h);

        //**********************
        //draw approx string locations for debugging
        this.context.fillStyle = "blue";
        this.context.save        ();
        this.context.translate   (start_x, h - start_y);
        this.context.beginPath   ();
        /*
        this.context.arc         (123*scale, 5*scale, 3, 0, 2*Math.PI);
        this.context.arc         (111.4*scale, 5*scale, 3, 0, 2*Math.PI);
        this.context.arc         (99.8*scale, 5*scale, 3, 0, 2*Math.PI);
        this.context.arc         (88.2*scale, 5*scale, 3, 0, 2*Math.PI);
        this.context.arc         (76.6*scale, 5*scale, 3, 0, 2*Math.PI);
        this.context.arc         (65*scale, 5*scale, 3, 0, 2*Math.PI);
        */
        this.context.arc         (133*scale, 5*scale, 3, 0, 2*Math.PI);
        this.context.arc         (121.4*scale, 5*scale, 3, 0, 2*Math.PI);
        this.context.arc         (109.8*scale, 5*scale, 3, 0, 2*Math.PI);
        this.context.arc         (98.2*scale, 5*scale, 3, 0, 2*Math.PI);
        this.context.arc         (86.6*scale, 5*scale, 3, 0, 2*Math.PI);
        this.context.arc         (75*scale, 5*scale, 3, 0, 2*Math.PI);
        
        this.context.fill        ();
        this.context.restore     ();
        
        //**********************
        //start main arm section
        this.context.save();
        this.context.lineWidth = 5;
        
        //joint 0 position
        this.context.fillStyle = "black";
        this.context.translate   (start_x, h - start_y);
        this.context.beginPath   ();
        this.context.arc         (0, 0, joint_radius, 0, 2*Math.PI);
        this.context.fill        ();
        this.context.fillText    (A0.toFixed(2) + " rad", 0, 20*scale);
        
        //segment 0;
        this.context.strokeStyle = "black";
        this.context.rotate      (Math.PI-a0);
        this.context.beginPath   ();
        this.context.moveTo      (0, 0);
        this.context.lineTo      (Finger.L0 * scale, 0);
        this.context.stroke      ();

        //joint 1 position
        this.context.fillStyle = "black";
        this.context.translate   (Finger.L0 * scale, 0);
        this.context.beginPath   ();
        this.context.arc         (0, 0, joint_radius, 0, 2*Math.PI);
        this.context.fill();

        //segment 1;
        this.context.strokeStyle = "black";
        this.context.rotate      (Math.PI-a1);
        this.context.beginPath   ();
        this.context.rotate      (-Finger.LEVER_ANGLE_1);
        this.context.moveTo      (-Finger.LEVER_LENGTH_1 * scale, 0);
        this.context.lineTo      (0, 0);
        this.context.rotate      (Finger.LEVER_ANGLE_1);
        this.context.lineTo      (Finger.L1 * scale , 0);
        this.context.stroke      ();

        //segment 2;
        this.context.strokeStyle = "black";
        this.context.translate   (Finger.L1 * scale, 0);
        this.context.rotate      (Math.PI-a2);
        this.context.beginPath   ();
        this.context.rotate      (-Finger.LEVER_ANGLE_2);
        this.context.moveTo      (-Finger.LEVER_LENGTH_2 * scale, 0);
        this.context.lineTo      (0, 0);
        this.context.rotate      (Finger.LEVER_ANGLE_2);
        this.context.lineTo      (Finger.L2 * scale, 0);
        this.context.stroke      ();
        
        //joint 2 position
        this.context.fillStyle = "orange";
        this.context.beginPath   ();
        this.context.arc         (0, 0, joint_radius, 0, 2*Math.PI);
        this.context.fill();
        
        //pick 2 position
        this.context.fillStyle = "orange";
        this.context.translate   (Finger.L2 * scale, 0);
        this.context.beginPath   ();
        this.context.arc         (0/*-joint_radius*/, 0, joint_radius, 0, 2*Math.PI);
        this.context.fill();
        
        this.context.restore();
        
        //**********************
        //start actuator section
        this.context.save();
        
        //outstick nub 1
        this.context.fillStyle = "black";
        this.context.lineWidth = 5;
        this.context.translate   (start_x, h - start_y);
        this.context.rotate      (Math.PI-a0);
        this.context.translate   (scale * (Finger.L0 - Finger.ZAP_PROJECTION_LENGTH_1), 0);
        this.context.save        ();
        this.context.rotate      (-Math.PI/2.0);
        this.context.beginPath   ();
        this.context.moveTo      (0, 0);
        this.context.lineTo      (scale * Finger.MOUNTING_OUTSTICK_LENGTH_1, 0);
        this.context.stroke      ();
        
        //attachment point 1
        this.context.fillStyle = "black";
        this.context.translate   (scale *  Finger.MOUNTING_OUTSTICK_LENGTH_1, 0);
        this.context.beginPath   ();
        this.context.arc         (0, 0, attachment_radius, 0, 2*Math.PI);
        this.context.fill();
        
        //actuator 1
        lever_leftover = Finger.LEVER_LENGTH_1 - Finger.MOUNTING_OUTSTICK_LENGTH_1 / Math.sin(a1 + Finger.LEVER_ANGLE_1);
        temp = lever_leftover * Math.sin(Math.PI - (a1 + Finger.LEVER_ANGLE_1));
        temp /= (A1 + Finger.ZAP_HOUSING_LENGTH_1);
        temp = Math.asin(temp);
        this.context.strokeStyle = "gray";
        this.context.lineWidth = 3;
        this.context.rotate      (-temp+(Math.PI/2.0));
        this.context.beginPath   ();
        this.context.moveTo      (0, 0);
        this.context.lineTo      (Finger.ZAP_HOUSING_LENGTH_1 * scale, 0);
        this.context.stroke      ();
        this.context.strokeStyle = "red";
        this.context.beginPath   ();
        this.context.moveTo      (Finger.ZAP_HOUSING_LENGTH_1 * scale, 0);
        this.context.lineTo      (scale * (Finger.ZAP_HOUSING_LENGTH_1 + A1), 0);
        this.context.stroke      ();
        this.context.fillText    (A1.toFixed(2) + " mm", Finger.ZAP_HOUSING_LENGTH_1+A1, -3*scale);
        
        //outstick nub 2
        this.context.fillStyle = "black";
        this.context.lineWidth = 5;
        this.context.restore     (-temp); //back to attachment point 1
        this.context.translate   (scale * Finger.ZAP_PROJECTION_LENGTH_1, 0);
        this.context.rotate      (Math.PI-a1);
        this.context.translate   (scale * (Finger.L1 - Finger.ZAP_PROJECTION_LENGTH_2), 0);
        this.context.rotate      (-Math.PI/2.0);
        this.context.beginPath   ();
        this.context.moveTo      (0, 0);
        this.context.lineTo      (scale * Finger.MOUNTING_OUTSTICK_LENGTH_2, 0);
        this.context.stroke      ();
        
        //attachment point 2
        this.context.translate   (scale *  Finger.MOUNTING_OUTSTICK_LENGTH_2, 0);
        this.context.beginPath   ();
        this.context.arc         (0, 0, attachment_radius, 0, 2*Math.PI);
        this.context.fill();

        //actuator 2
        lever_leftover = Finger.LEVER_LENGTH_2 - Finger.MOUNTING_OUTSTICK_LENGTH_2 / Math.sin(a2 + Finger.LEVER_ANGLE_2);
        temp = lever_leftover * Math.sin(Math.PI - (a2 + Finger.LEVER_ANGLE_2));
        temp /= A2 + Finger.ZAP_HOUSING_LENGTH_2;
        temp = Math.asin(temp);
        this.context.strokeStyle = "gray";
        this.context.lineWidth = 3;
        this.context.rotate      (-temp+(Math.PI/2.0));
        this.context.beginPath   ();
        this.context.moveTo      (0, 0);
        this.context.lineTo      (Finger.ZAP_HOUSING_LENGTH_2 * scale, 0);
        this.context.stroke      ();
        this.context.strokeStyle = "red";
        this.context.beginPath   ();
        this.context.moveTo      (Finger.ZAP_HOUSING_LENGTH_2 * scale, 0);
        this.context.lineTo      (scale * (Finger.ZAP_HOUSING_LENGTH_2 + A2), 0);
        this.context.stroke      ();
        this.context.fillText    (A2.toFixed(2) + " mm", Finger.ZAP_HOUSING_LENGTH_1+A1, -3*scale);
  
        this.context.restore();

      };

      /*--------------------------------------------------------------------*/
      Finger.prototype.onmousedown = function(e)
      {
        this.mouse_is_down = true;
  
        var rect = this.canvas.getBoundingClientRect();
        var x = (e.clientX - rect.left) * this.canvas.width / this.canvas.clientWidth;
        var y = (e.clientY - rect.top) * this.canvas.width / this.canvas.clientWidth;

        y = this.canvas.height - y;
        x /= Finger.MM_TO_PIXELS_SCALE;
        y /= Finger.MM_TO_PIXELS_SCALE;
        x -= Finger.START_X;
        y -= Finger.START_Y;
        
        //console.log("p3.x: " + x + "p3.y: " + y);
         
        var tempx = this.p3x - x;
        var tempy = this.p3y - (y-5);
        
        if(Math.sqrt(Math.abs(tempx*tempx + tempy*tempy)) <= (5*Finger.MM_TO_PIXELS_SCALE))
          this.mouse_is_down_in_p3 = true;

        tempx = this.p2x - x
        tempy = this.p2y - y;
        
        if(Math.sqrt(Math.abs(tempx*tempx + tempy*tempy)) <= (5*Finger.MM_TO_PIXELS_SCALE))
          this.mouse_is_down_in_p2 = true;
      };

      /*--------------------------------------------------------------------*/
      Finger.prototype.onmouseup   = function(e)
      {
        this.mouse_is_down = this.mouse_is_down_in_p2 = this.mouse_is_down_in_p3 = false;
      };

      /*--------------------------------------------------------------------*/
      Finger.prototype.onmousemove = function(e)
      {
        //if(this.mouse_is_down)
          //this.onmousedown(e);
        
        if(this.mouse_is_down)
          {
            var rect = this.canvas.getBoundingClientRect();
            var x = (e.clientX - rect.left) * this.canvas.width / this.canvas.clientWidth;
            var y = (e.clientY - rect.top) * this.canvas.width / this.canvas.clientWidth;

            y = this.canvas.height - y;
            x /= Finger.MM_TO_PIXELS_SCALE;
            y /= Finger.MM_TO_PIXELS_SCALE;
            x -= Finger.START_X;
            y -= Finger.START_Y;
        
            if(this.mouse_is_down_in_p3)
              {
                set_xy(x, y);
              }
            else if(this.mouse_is_down_in_p2)
              {
                if(y > this.p3y)
                  {
                    var new_a = Math.atan(-(y-this.p3y)/(x-this.p3x));
                    if(new_a < 0) new_a = Math.PI + new_a;
                    set_a(new_a);
                  }
                else
                  this.mouse_is_down_in_p2 = false;
              }
          }
      };

      /*--------------------------------------------------------------------*/
      Finger.prototype.touchstart = function(e)
      {
        var touch = e.touches[0];
        var mouseEvent = new MouseEvent("mousedown",
          {
            target: e.target,
            screenX: touch.screenX,
            screenY: touch.screenY,
            clientX: touch.clientX,
            clientY: touch.clientY
          });
        this.canvas.dispatchEvent(mouseEvent);
      };

      /*--------------------------------------------------------------------*/
      Finger.prototype.touchend = function(e)
      {
        var mouseEvent = new MouseEvent("mouseup", {});
        this.canvas.dispatchEvent(mouseEvent);
      };

      /*--------------------------------------------------------------------*/
      Finger.prototype.touchmove = function(e)
      {
        var touch = e.touches[0];
        var mouseEvent = new MouseEvent("mousemove",
          {
            screenX: touch.screenX,
            screenY: touch.screenY,
            clientX: touch.clientX,
            clientY: touch.clientY
          });
        this.canvas.dispatchEvent(mouseEvent);
      };

      /*--------------------------------------------------------------------*/
      Finger.prototype.prevent_touch_scroll = function(e)
      {
        /*
        if ((e.target == this.canvas) && (this.mouse_is_down_in_goal_indicator))
          e.preventDefault();
        else if ((e.target == this.canvas) && (this.mouse_is_down_in_goal_indicator_2) && (this.style == Finger.STYLE_RANGE))
          e.preventDefault();
        */
      };

      /*--------------------------------------------------------------------*/
      Finger.prototype.get_touch_position = function(canvas, e)
      {
        var rect = canvas.getBoundingClientRect();
        var result =
          {
           x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top
          };
        return result;
      };
    </script>
  </head>


  <body onload="init_page()">
    <div class="page_div">
      <div class="top_buttons_div">
        <div class="dropdown_div">
          <b>Finger ID</b>
          <select id="finger_id_div" onchange="set_finger_id(this.value)">
            <option value="0" selected>0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </div>
        <div class="dropdown_div">
        </div>
        <div class="dropdown_div">
          <div class="select_div">
            <b>MIDI Device</b>
            <select id="midi_device_list">
            </select>
          </div>
        </div>
        <div class="dropdown_div">
          <b>String ID</b>
          <select id="string_id_div" onchange="set_string_id(this.value)">
            <option value="1" selected>e</option>
            <option value="2">b</option>
            <option value="3">G</option>
            <option value="4">D</option>
            <option value="5">A</option>
            <option value="6">E</option>
          </select>
        </div>

        <div class="dropdown_div">
          <b>Strum End</b>
          <select id="string_id_div" onchange="set_strum_end(this.value)">
            <option value="1" selected>e</option>
            <option value="2">b</option>
            <option value="3">G</option>
            <option value="4">D</option>
            <option value="5">A</option>
            <option value="6">E</option>
          </select>
        </div>

        <b>Double Damp:</b><input type="checkbox" onchange="set_double_damp(this.checked)">

        <div class="button_div">
          <div class="button_container"><button type="button" onclick="rh_capture_string()">Capture String</button></div>
          <div class="button_container"><button type="button" onclick="rh_move_to_string()">Move To String</button></div>
          <div class="button_container"><button type="button" onclick="pluck_string()">Pluck String</button></div>
          <div class="button_container"><button type="button" onclick="damp_string()">Damp String</button></div>
          <div class="button_container"><button type="button" onclick="strum()">Strum</button></div>
        </div>
      </div><!--top_buttons_div-->
     
      <hr>

      <div class="params_div">
        <div class="param_container" data-parameter="x">
          <div class="label_div">x</div>
          <div class="value_div"><input type="number" onchange="set_x(this.value);"></div>
        </div>
        <div class="param_container" data-parameter="y">
          <div class="label_div">y</div>
          <div class="value_div"><input type="number" onchange="set_y(this.value);"></div>
        </div>
        <div class="param_container" data-parameter="a">
          <div class="label_div">&#x0251;</div>
          <div class="value_div"><input type="number" onchange="set_a(this.value);" step="0.05"></div>
        </div>
      </div><!--params_div-->
      <div class="canvas_div">
        <canvas width='1000' height='500' id='finger_widget' style='display:block; width:100%; margin:2em auto 2em auto; touch-action:none;'></canvas>
      </div>
      <hr>
      <div class="log_container_div">
        <div class="log_outer_div"><div class="log_div" id="log"></div></div>
        <div class="button_div">
          <input type="checkbox" onclick="should_log=this.checked">Log</input><br>
          <button type="button" onclick="rh_enable_torque(true)">Force On</input><br>
          <button type="button" onclick="rh_enable_torque(false)">Force Off</input><br>
          <button type="button" onclick="clear_log()">clear</button>
          <button type="button" onclick="get_calculated_endpoint_position()">sync</button>
        </div>
      </div>
    </div><!--page_div-->
  </body>
</html>
